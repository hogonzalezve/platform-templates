apiVersion: platform.nttdata.io/v1alpha1
kind: AppModelA
metadata:
  name: ${{ values.uniqueName }}
  namespace: ${{ values.requestNamespace | default('kratix-worker-system') }}
  labels:
    app: ${{ values.uniqueName }}
    created-by: backstage
    request-id: "${{ values.randomId | default('unknown') }}"
  annotations:
    backstage.io/created-at: "${{ values.timestamp | default('' | moment) }}"
    backstage.io/requested-by: "${{ user.entity.metadata.name | default('unknown') }}"
spec:
  appName: ${{ values.baseAppName | default(values.appName) }}
  namespace: ${{ values.targetNamespace }}
  image: ${{ values.image }}
  port: ${{ values.port | default(80) }}
  replicas: ${{ values.replicas | default(1) }}
  serviceType: ${{ values.serviceType | default('ClusterIP') }}
  imagePullPolicy: ${{ values.imagePullPolicy | default('Always') }}
  gateway:
    enabled: ${{ values.gatewayEnabled | default(false) }}
{%- if values.gatewayEnabled %}
    hostname: "${{ values.gatewayHostname }}"
    gatewayName: "nginx-gateway"
    gatewayNamespace: "nginx-gateway-system"
    path: "${{ values.gatewayPath | default('/') }}"
    tls: ${{ values.gatewayTls | default(false) }}
{%- else %}
    hostname: ""
    gatewayName: "nginx-gateway"
    gatewayNamespace: "nginx-gateway-system"
    path: "/"
    tls: false
{%- endif %}
  storage:
    enabled: ${{ values.storageEnabled | default(false) }}
{%- if values.storageEnabled %}
    size: "${{ values.storageSize }}"
    storageClass: "${{ values.storageClass }}"
    mountPath: "${{ values.storageMountPath }}"
{%- else %}
    size: "1Gi"
    storageClass: "gp3"
    mountPath: "/data"
{%- endif %}
  database:
    enabled: ${{ values.databaseEnabled | default(false) }}
{%- if values.databaseEnabled %}
    type: "${{ values.databaseType }}"
    claimApiVersion: "database.example.org/v1alpha1"
    claimKind: "PostgreSQLInstance"
    claimName: "${{ values.uniqueName }}-db"
    parameters:
      engine: {% if values.databaseType == 'postgresql' %}"postgres"{% elif values.databaseType == 'mysql' %}"mysql"{% else %}"mongodb"{% endif %}
      version: {% if values.databaseType == 'postgresql' %}"15"{% elif values.databaseType == 'mysql' %}"8.0"{% else %}"6.0"{% endif %}
      instanceSize: "${{ values.databaseInstanceSize }}"
      storageGB: ${{ values.databaseStorageGB }}
      username: "{{ values.appName }}user"
      publiclyAccessible: false
{%- else %}
    type: "postgresql"
    claimApiVersion: "database.example.org/v1alpha1"
    claimKind: "PostgreSQLInstance"
    claimName: ""
    parameters:
      engine: "postgres"
      version: "15"
      instanceSize: "db.t3.micro"
      storageGB: 20
      username: "appuser"
      publiclyAccessible: false
{%- endif %}